# Kubernetes deployment for RL Arena Executor

apiVersion: v1
kind: Namespace
metadata:
  name: rl-arena

---
# ServiceAccount for executor
apiVersion: v1
kind: ServiceAccount
metadata:
  name: rl-arena-executor
  namespace: rl-arena

---
# Role for creating and managing Jobs
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: rl-arena-executor-role
  namespace: rl-arena
rules:
  - apiGroups: ["batch"]
    resources: ["jobs"]
    verbs: ["create", "get", "list", "watch", "delete"]
  - apiGroups: [""]
    resources: ["pods", "pods/log"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["create", "get", "delete"]

---
# RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: rl-arena-executor-binding
  namespace: rl-arena
subjects:
  - kind: ServiceAccount
    name: rl-arena-executor
    namespace: rl-arena
roleRef:
  kind: Role
  name: rl-arena-executor-role
  apiGroup: rbac.authorization.k8s.io

---
# ConfigMap for executor configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: executor-config
  namespace: rl-arena
data:
  config.yaml: |
    executor:
      use_k8s: true
    k8s:
      namespace: rl-arena
      orchestrator_image: rl-arena-orchestrator:latest
    resource_limits:
      cpu_count: 1
      memory_limit: "512m"
      step_timeout_sec: 5
      match_timeout_sec: 300
    sandbox:
      tmp_dir: "/tmp/agent_code"
      replay_dir: "/tmp/replays"
      max_code_size_mb: 50

---
# Executor Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rl-arena-executor
  namespace: rl-arena
  labels:
    app: rl-arena-executor
spec:
  replicas: 2
  selector:
    matchLabels:
      app: rl-arena-executor
  template:
    metadata:
      labels:
        app: rl-arena-executor
    spec:
      serviceAccountName: rl-arena-executor
      containers:
        - name: executor
          image: rl-arena-executor:latest
          imagePullPolicy: IfNotPresent
          ports:
            - name: grpc
              containerPort: 50051
              protocol: TCP
          env:
            - name: CONFIG_PATH
              value: /config/config.yaml
            - name: LOG_LEVEL
              value: INFO
          volumeMounts:
            - name: config
              mountPath: /config
              readOnly: true
          resources:
            requests:
              cpu: 500m
              memory: 512Mi
            limits:
              cpu: 1000m
              memory: 1Gi
          livenessProbe:
            exec:
              command:
                - python
                - -c
                - "import grpc; print('ok')"
            initialDelaySeconds: 10
            periodSeconds: 30
          readinessProbe:
            exec:
              command:
                - python
                - -c
                - "import grpc; print('ok')"
            initialDelaySeconds: 5
            periodSeconds: 10
      volumes:
        - name: config
          configMap:
            name: executor-config

---
# Executor Service
apiVersion: v1
kind: Service
metadata:
  name: rl-arena-executor
  namespace: rl-arena
  labels:
    app: rl-arena-executor
spec:
  type: ClusterIP
  ports:
    - port: 50051
      targetPort: 50051
      protocol: TCP
      name: grpc
  selector:
    app: rl-arena-executor

---
# PersistentVolumeClaim for replays
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: replay-storage
  namespace: rl-arena
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 10Gi
  storageClassName: standard
